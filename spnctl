#!/usr/bin/env bash

set -e

if [[ "${DEBUG}" ]]; then
    set -x
fi

die () {
    echo >&2 -e "$*"
    exit 1
}

babashka_version="0.4.5"
docker_compose_version="1.29.2"

command -v curl > /dev/null || die "Missing required dependency: curl"

mkdir -p bin

# TODO check whether Docker is installed

docker_compose=$(command -v docker-compose || true)
if [ "${docker_compose}" == "" ]; then
    docker_compose="$(pwd)/bin/docker-compose"
fi

installed_docker_compose_version="0.0.0"
if [ -e "${docker_compose}" ]; then
    installed_docker_compose_version=$("${docker_compose}" --version | grep -o '[0-9]\{1,\}\.[0-9]\{1,\}\.[0-9]\{1,\}')
fi

if [ "1.13.0" != "$(echo -e "${installed_docker_compose_version}\n1.13.0" | sort -V | head -n1)" ]; then
    echo >&2 "Missing or old version of required dependency: docker-compose; downloading docker-compose version ${docker-compose_version}..."
    curl -sS -L "https://github.com/docker/compose/releases/download/${docker_compose_version}/docker-compose-$(uname -s)-$(uname -m)" -o "${docker_compose}"

    echo "Verify checksum..."
    if ! sha256sum -c .docker-compose.checksum; then
        rm "${docker_compose}"
        exit 1
    fi

    chmod 755 "${docker_compose}"
fi

bb="$(pwd)/bin/bb"

installed_babashka_version="0.0.0"
if [ -e "${bb}" ]; then
    installed_babashka_version=$("${bb}" --version | grep -o 'v[0-9]\{1,\}\.[0-9]\{1,\}\.[0-9]\{1,\}')
fi

if [ "${babashka_version}" != "$(echo -e "${installed_babashka_version}\n${babashka_version}" | sort -V | head -n1)" ]; then
    echo >&2 "Downloading Babashka version ${babashka_version}..."
    bb_tgz="babashka-${babashka_version}-linux-amd64-static.tar.gz"
    curl -sS -L "https://github.com/babashka/babashka/releases/download/v${babashka_version}/${bb_tgz}" -O
    tar -C bin -xzf "${bb_tgz}"
    rm "${bb_tgz}"

    echo "Verify checksum..."
    if ! sha256sum -c .bb.checksum; then
        rm "${bb}"
        exit 1
    fi

    chmod 755 "${bb}"
fi

# TODO check whether huge pages are enabled

if [[ $# = 0 ]]; then
    $bb --tasks
    exit
fi

PATH="$(pwd)/bin:$PATH"
export PATH

"${bb}" run "$@"
